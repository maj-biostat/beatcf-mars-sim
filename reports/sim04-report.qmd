---
title: BEAT CF MARS
subtitle: Simulation Report
description: |
    Three-arm Bayesian adaptive trial nested within BEAT-CF platform evaluating antibiotic-sparing strategies for managing pulmonary exacerbations
date: last-modified
date-format: "D MMMM YYYY"
author: 
  - name: Mark Jones
    id: mj
    email: mark.jones1@sydney.edu.au
version: 0.1
sponsor: "University of Sydney, NSW, Australia"
protocol-number: todo
registration: todo
hrec: todo
ci1: Tom Snelling
editor: source
bibliography: ../etc/refs.bib
csl: ../etc/elsevier-harvard.csl
# number-sections required otherwise section refs will not render 
number-sections: true
toc: true
toc-depth: 3
format:
  pdf: 
    pdf-engine: xelatex
    keep-tex: true
    documentclass: scrreprt
    papersize: a4
    fontsize: 12pt
    mainfont: Libertinus Serif
    sansfont: Libertinus Sans
    monofont: Libertinus Mono
    mathfont: Libertinus Math
    linestretch: 1.25
    template-partials: 
      - "../_extensions/partials/before-body.tex"
    include-in-header:
      text: |
       \usepackage{physics}
       \setkomafont{chapter}{\fontsize{16}{18}\selectfont}
       \setkomafont{section}{\fontsize{14}{16}\selectfont}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE
)
```

```{r}
#| echo: false

# uml digs
suppressPackageStartupMessages(library(nomnoml))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(qs))
suppressPackageStartupMessages(library(git2r))
suppressPackageStartupMessages(suppressWarnings(library(gt)))
suppressPackageStartupMessages(library(ggh4x))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(scales))
suppressPackageStartupMessages(library(patchwork))
suppressPackageStartupMessages(library(pbapply))


toks <- unlist(tstrsplit(getwd(), "/")) 
if(toks[length(toks)] == "beatcf-mars-sim"){
  prefix_cfg <- "./etc/sim04/"
  prefix_stan <- "./stan"
  prefix_fig <- "./fig"
  prefix_data <- "./data"
  prefix_r <- "./r"
} else {
  prefix_cfg <- "../etc/sim04/"
  prefix_stan <- "../stan"
  prefix_fig <- "../fig"
  prefix_data <- "../data"
  prefix_r <- "../r"
}


source(paste0(prefix_r, "/data.R"))
source(paste0(prefix_r, "/data-sim04.R"))

# Reference design

sim_lab <- "sim00-01"

flist <- list.files(paste0(prefix_data, "/", sim_lab), pattern = "sim00")
toks <- list()
l0 <- list()
i <- 1

for(i in 1:length(flist)){

  l0[[i]] <- qs::qread(file.path(paste0(prefix_data, "/", sim_lab), flist[i]))
}



# Each input file corresponds to the results from a single simulation
# scenario/configuration.
# Load all the files into a single list.

# files of interest
sim_lab <- "sim04-05"

flist <- list.files(paste0(prefix_data, "/", sim_lab), pattern = "sim04")
toks <- list()
l <- list()
i <- 1

for(i in 1:length(flist)){

  l[[i]] <- qs::qread(file.path(paste0(prefix_data, "/", sim_lab), flist[i]))
  toks[[i]] <-  unlist(tstrsplit(flist[i], "[-.]"))
}

N_sims <- l[[1]]$cfg$nsim

N_example_sims <- 7

# temp to replace
# l_spec <- get_prototype_cfg()
l_spec_1 <- l[[1]]$cfg
```

{{< pagebreak >}}

::: summary
|     |        |
|:----|:------------|
|Study title:  |  BEAT-CF MARS |
|Reference intervention: |  Standard airway clearance therapy at least twice per day for 14 days, plus 14 days of oral antibiotics commencing as soon as practicable (and â‰¥ 72 hours and < 7 days) after onset of new or acute worsening of cough. |   
|Intervention: | (1) Deferred antibiotic strategy (2) Early discontinuation antibiotic strategy. |   
|Outcome: | ppFev1 at 12 months |   
|Study design:  |   Bayesian adaptive trial with early stopping rules | 
|Sponsor:  |    University of Sydney, NSW, Australia | 
Protocol: |  todo |
|Registration:  |    todo | 
|HREC:  |   todo | 
|Study date of first consent:  |   todo | 
|Principal coordinating investigators:  |   Tom Snelling | 
:::

<!-- 
Note that the above relies on the pandoc extension implemented in the lua file 
in the etc directory. It additionally relies on the presence of a custom style
in word called study summary. It will currently only work for word (because I
cannot be bothered to implement it in anything else at the moment).
-->


{{< pagebreak >}}

# Version history {.unlisted .unnumbered}

| Version    |   Date     | Change    |   Reason     |
|:----|:------------|:----|:------------|
| 0.1 | 2025-11-12 | First version | N/A |


{{< pagebreak >}}



# Introduction

This report documents the simulation approach and results for the operating characteristics for the BEAT-CF MARS study.
The report is an operational document that will be updated, as necessary, over the course of the study.
It should be read in conjunction with the relevant versions of the protocol and statistical analysis plan.

We provide the data generation assumptions, modelling approaches, scenarios and results that were used to explore the design.

These results are based on simulation `r sim_lab` with `r N_sims` simulated trials run per scenario.

The key configuration parameters that persist across all scenarios are shown below:

+ Interim analyses: `r cumsum(l_spec_1$N)`
+ Futility evaluation at: `r cumsum(l_spec_1$N)`
+ Non-inferiority evaluation at: `r cumsum(l_spec_1$N)`
+ Enrolment per day after ramp up: `r l_spec_1$pt_per_day`
+ Ramp up period (days): `r l_spec_1$ramp_up_days`
+ Standard deviation on baseline ppFEV1: `r l_spec_1$sigma_mu0`
+ Standard deviation on ppFEV1: `r l_spec_1$sigma`
+ Correlation between repeat measures: `r l_spec_1$rho`
+ Reference value for non-inferiority: `r l_spec_1$delta$ni`
+ Evidential threshold for non-inferiority (probability): `r l_spec_1$thresh$ni`
+ Reference value for futility: `r l_spec_1$delta$fut`
+ Evidential threshold for futility (probability): `r l_spec_1$thresh$fut`



 

# Design overview

BEAT-CF-MARs is a non-inferiority study that uses a longitudinal design with lung function measured under each of the active treatment strategies at the follow up visits to 12 months post randomisation.
Currently, a baseline reading and `r l_spec_1$n_sprty_obs` follow up visits are assumed (equally spaced over the 12 months).

Participants are randomised with equal allocation to one of the three strategies at enrolment and this allocation is assumed to hold over the 12 month period.
Whenever an exacerbation occurs (participants may have $0, 1, 2, \dots$ exacerbations) the treatment regime that was assigned is implemented per the protocol specification.

The primary outcome measure, ppFEV1 (percent predicted forced expiratory volume in one second) characterises lung function on how well a person can exhale air in one second compared to what is expected for someone of their age, height, sex, and race.
When the lungs are working properly, the values should be close to 100% (values above 100% are possible and common in young people).

For the measure of treatment effect, we constrast the difference in the mean lung function at 12-months between the delayed strategy versus the standard of care and the deferred strategy versus the standard of care.

The design includes adaptation that permits early stopping of treatment arms for non-inferiority or futility.
The control arm of standard of care remains the reference arm throughout.

## Alternatives

Variations on the design might include:

+ Model the number/frequency/severity of exacerbations with the goal of characterising more of the variation and therefore improve precision on the treatment effects of interest
+ Re-randomised participants to alternative treatments over the 12 month period; patients would be randomised on each exacerbation in a cross-over type design
+ Focus attention on one of the two active arms rather than both (in an attempt to make the most of our 600 patients)



# Data generation {#sec-data-generation}

The distributional assumptions of each data component follows.

The participant characteristics and their outcome variables are generated as cohorts prior to each analysis such that the data accrues sequentially.
As the trial progresses, decisions may be made which lead to early stopping of treatment arms.

We simulate ppFEV1 at baseline and over the 12 months of follow up.
ppFEV1 progression is assumed to be conditional on baseline ppFEV1 value (in a well state), age at entry, a time trend and treatment effect.

The population age distribution is assumed to be truncated log-normal with a lower and upper bound of `r l_spec_1$age_lwr` and `r l_spec_1$age_upr` and is distributed as per @fig-age0.

```{r, echo = F}
#| label: fig-age0
#| fig-cap: 'Age class distribution of simulated trial population'
#| fig-height: 5
#| fig-width: 5
#| fig-pos: H


# age distribution - truncated log normal - restrict age to (age_lwr,age_upr)
p_lt_age_lwr <- plnorm(
  l_spec_1$age_lwr, meanlog = l_spec_1$age_mu, sdlog = l_spec_1$age_sig, lower.tail = T)
p_gt_age_upr <- plnorm(
  l_spec_1$age_upr, meanlog = l_spec_1$age_mu, sdlog = l_spec_1$age_sig, lower.tail = F)
# sample u in [p0, 1)
u <- p_lt_age_lwr + runif(1e5, 0, (1 - (p_lt_age_lwr + p_gt_age_upr)))
baseline_age <- qlnorm(u, meanlog = l_spec_1$age_mu, sdlog = l_spec_1$age_sig)
d_fig <- data.table(age0 = baseline_age)


ggplot(d_fig, aes(x = age0)) +
  geom_histogram(bins = 30, fill = "grey", col = "black") +
  scale_x_continuous("Baseline age") +
  scale_y_continuous("") +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.box="horizontal",
    strip.text.y.right = element_text(angle = 0,
                                      hjust = 0,
                                      vjust = 0.2,
                                      size = 7),
    axis.ticks = element_blank(),
    strip.text.x.top = element_text(size = 7),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "grey",
                                  linewidth = 0.1,
                                  linetype = 1),
    axis.title.y=element_text(size = 7),
    axis.text.y = element_blank(),
    axis.text.x =  element_text(size = 7),
    axis.title.x = element_text(size = 7),
    legend.text = element_text(size = 7)
  ) 

```


The participant ppFEV1 at baseline is modelled conditional on an assumed population level ppFEV1 and the logarithm of age at enrolment:

$$
\begin{aligned}
Y_{i,0} &\sim N(\mu_{i,0}, \sigma_0) \\
\mu_{i,0} &= \beta_0 + \log(\text{age}_0) \\
\end{aligned}
$$

Spirometry is collected at `r l_spec_1$n_sprty_obs` follow up visits over the 12-month period.
The follow up values are assumed to be normally distributed conditional on the baseline value, time and treatment parameters:

$$
\begin{aligned}
Y_{ij} &\sim N(\mu_{i,j}, \Sigma) \\
\mu_{i,j} &= \mu_{i,0} + \sum_{g=1}^2 \beta_{T,g} T_{i,g} + \sum_{k=1}^K \beta_{t,k} B_k(t_{i,j}) + \sum_{g=1}^2 \sum_{k=1}^K \beta_{t \times T,k,g} (T_{i,g} B_k(t_{i,j})) \\
\Sigma_{pq} &= \sigma^2 \rho^{|p-q|} 
\end{aligned}
$$

where $\mu_{i,0}$ is the participant baseline ppFEV mean, $T_{i,g}$ provides an indicator of treatment status with $g = 1, 2$ (for delayed and deferred strategies respectively) and $t_{i,j}$ gives the $j^{th}$ visit time.
The $B_k$ provide a piecewise linear basis that operate on $t_{i,j}$ assuming a linearity for ppFEV1 within the nominated segements (e.g. months 1 through 3, 3 through 6 etc).
The within subject correlation is implemented via AR1 residual covariance matrix, $\Sigma$.

```{r, echo = F}

l_spec_tmp <- copy(l_spec_1)
l_spec_tmp$N <- 1000
l_spec_tmp$is <- 1
l_spec_tmp$ie <- l_spec_tmp$N

```

```{r, echo = F}
d <- get_sim04_trial_data(l_spec_tmp)
d[, age := age0 + (t_id/l_spec_tmp$n_sprty_obs)]

q_p <- c(0.10, 0.50, 0.90)
q_age0 <- quantile(d$age0, probs = q_p)

ix_q <- sapply(q_age0, function(z){ 
  which.min(abs(d$age0 - z))
  })

id_q <- d[ix_q, id]
```

For example, the mean and observed ppFEV1 along with the residual autocorrelation function for participants at the approxiamte `r paste0(100*q_p, "%", collapse = ", ")` percentiles for baseline age are shown in @fig-ppfev1-age0-ex.

```{r, echo = F}
#| label: fig-ppfev1-age0-ex
#| fig-cap: 'Progression of mean and observed ppFEV1 (LHS) residual ACF (RHS)'
#| fig-height: 5
#| fig-width: 7
#| fig-pos: H


d_fig <- d[id %in% id_q][order(age0)]
d_fig[, q_p := rep(q_p, each = l_spec_1$n_sprty_obs)]
d_fig[, age0_lab := sprintf("Percentile %.0f, baseline age %.1f year, ID %.0f", 100*q_p, age0, id)]
d_fig[, resid := y - mu]


p1 <- ggplot(d_fig, aes(x = age, y = mu)) +
  geom_line(alpha = 1, lwd = 0.4) +
  geom_line(aes(y = y), alpha = 0.5, lwd = 0.4) +
  geom_point(size= 1) +
  scale_x_continuous("Age") +
  scale_y_continuous("Observed ppFEV1") +
  facet_wrap(~ age0_lab, ncol = 1, scales = "free") +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.box="horizontal",
    strip.text.y.right = element_text(angle = 0,
                                      hjust = 0,
                                      vjust = 0.2,
                                      size = 7),
    axis.ticks = element_blank(),
    strip.text.x.top = element_text(size = 7),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "grey",
                                  linewidth = 0.1,
                                  linetype = 1),
    axis.title.y=element_text(size = 7),
    axis.text.y = element_text(size = 7),
    axis.text.x =  element_text(size = 7),
    axis.title.x = element_text(size = 7),
    legend.text = element_text(size = 7)
  ) 

d_fig_acf <- do.call(rbind, lapply(id_q, function(z){
  acf_out <-  acf(d_fig[id == z, resid], plot = F)
  data.table(
    id = z,
    t = 1:(acf_out$n.used-1),
    acf = as.numeric(acf_out$acf)
  )
}))

d_fig_acf[, lab := sprintf("ACF ID %.0f", id)]

p2 <- ggplot(d_fig_acf, aes(x = t)) +
  geom_linerange(aes(ymin = 0, ymax = acf)) +
  scale_x_continuous("Visit", breaks = 1:(l_spec_1$n_sprty_obs-1)) +
  facet_wrap(~lab, ncol = 1) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.box="horizontal",
    strip.text.y.right = element_text(angle = 0,
                                      hjust = 0,
                                      vjust = 0.2,
                                      size = 7),
    axis.ticks = element_blank(),
    strip.text.x.top = element_text(size = 7),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "grey",
                                  linewidth = 0.1,
                                  linetype = 1),
    axis.title.y=element_text(size = 7),
    axis.text.y = element_text(size = 7),
    axis.text.x =  element_text(size = 7),
    axis.title.x = element_text(size = 7),
    legend.text = element_text(size = 7)
  ) 

p1 + p2
```


```{r, echo = F}

l_spec_tmp <- copy(l_spec_1)
l_spec_tmp$N <- 100
l_spec_tmp$is <- 1
l_spec_tmp$ie <- l_spec_tmp$N

```

As another example, observed ppFEV1 for a random selection of `r l_spec_tmp$N` participants followed over 12 months (no differential treatment groups) are shown in @fig-ppfev1-age-prog.

```{r, echo = F}
#| label: fig-ppfev1-age-prog
#| fig-cap: 'Indicative progression of observed ppFEV1 by age based on simulation parameters'
#| fig-height: 4
#| fig-width: 6
#| fig-pos: H

d <- get_sim04_trial_data(l_spec_tmp)
d[, age := age0 + (t_id/l_spec_tmp$n_sprty_obs)]

brks_y <- seq(0, 150, by = 10)

ggplot(d, aes(x = age, y = y)) +
  geom_line(aes(group = id), alpha = 0.1, lwd = 0.4) +
  geom_point(alpha = 0.2, size= 0.5) +
  geom_smooth(se = F, method = "gam", 
              formula = y ~ s(x, bs = "tp"), lwd = 0.4) +
  scale_x_continuous("Age") +
  scale_y_continuous("Observed ppFEV1", breaks = brks_y) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.box="horizontal",
    strip.text.y.right = element_text(angle = 0,
                                      hjust = 0,
                                      vjust = 0.2,
                                      size = 7),
    axis.ticks = element_blank(),
    strip.text.x.top = element_text(size = 7),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "grey",
                                  linewidth = 0.1,
                                  linetype = 1),
    axis.title.y=element_text(size = 7),
    axis.text.y = element_text(size = 7),
    axis.text.x =  element_text(size = 7),
    axis.title.x = element_text(size = 7),
    legend.text = element_text(size = 7)
  ) 
```

Treatment status is assumed to be allocated 1:1:1, which is updated to 1:1 if a decision threshold is reached for non-inferiority or futility.
The initial standard of care remains the reference group throughout and the study.

Accrual is assumed to follow a non-homogenous poisson process ramping up over `r l_spec_1$ramp_up_days` days with around `r l_spec_1$pt_per_day` enrolments per day.

# Modelling {#sec-modelling}

## Overview

While the analysis will adopt a mean model and an AR1 structured covariance for the residuals, a full MCMC approach is too intensive for the purposes of simulation.
Therefore, for the simulation work, the Bayesian model is implemented via a Laplacian approximation.
Specifically, we use GLS (with AR1 errors) to produce point estimates and covariance matrix for the parameters of interest and then draw the posterior from a multivariate normal distribution.

The outcome (observed ppFEV1) is regressed on the (observed) baseline value for ppFEV1, log(age0), time and treatment assignment and piecewise linear basis functions:

$$
\begin{aligned}
Y_{ij} &\sim N(\mu_{ij}, \Sigma) \\
\mu_{ij} &= \beta_0 + \beta_1 Y_{i,0} + \beta_2 \log(\text{age}_{i,0})  + \sum_{g=1}^2 \beta_{T,g} T_{i,g} + \\ 
&\quad \quad  \sum_{k=1}^K \beta_{t,k} B_k(t_{i,j}) + \sum_{g=1}^2 \sum_{k=1}^K \beta_{t \times T,k,g} (T_{i, g} B_k(t_{i,j})) \\ 
\Sigma_{pq} &= \sigma^2 \rho^{|p-q|} \\
\end{aligned}
$$

where $T_{i,g}$ are indicators of treatment group membership for the delayed and deferred arms and $t_{i,j}$ denotes the follow up visit.
We note that while piecewise linear regression is adopted here for simplicity, a smoother of some form may be preferable in the actual analysis.

# Decision procedures

The decision processes are based on the current participant data for all enrolments that have reached the first follow up.
This approach is simple and offers a transparent interpretation, but it ignores the possibility that accumulating data may shift the posterior.
The decision thresholds and evidential thresholds are shown in @tbl-dec-thresholds.

```{r}
#| echo: FALSE
#| label: tbl-dec-thresholds
#| tbl-pos: H
#| tbl-cap: "Decision threshold parameters"

d_dec_pars <- data.table(
  desc = c("NI", "Futility"),
  ref_value = c(l_spec_1$delta$ni, l_spec_1$delta$inf),
  threshold = c(l_spec_1$thresh$ni, l_spec_1$thresh$inf)
)


gt_tbl <- gt(d_dec_pars) |>
  cols_align(
    columns = 1,
    align = "left"
  ) |>
  cols_align(
    columns = 2:3,
    align = "center"
  )  |>
  cols_label(
    desc = "Decision type",
    ref_value = "Reference value",
    threshold = "Threshold"
  ) |>
  tab_options(
    table.width = pct(60),
    table.font.size = pct(55)) 

gt_tbl 

```

In the current implementation, we evaluate non-inferiority and futility at each interim and, if a decision threshold is met, then we will stop recruitment into the relevant arm.
Standard of care remains the reference arm throughout.
This approach is adopted for each interim and the final analysis and is reflected in the current set of results.

The trial setup is such that if the intervention were beneficial, it would reduce the rate of decline for ppFEV1 and we are therefore considering negative non-inferiority margins.
Specifically, if an intervention arm is non-inferior to the reference arm, then the follow up ppFEV1 on the intervention will be reduced by no more than the non-inferiority margin.
Conversely, if the ppFEV1 on the intervention arm falls below the futility reference vaule with very high probability, then we conclude futility.

+ For non-inferiority, we evaluate $\text{Pr}(\delta > \epsilon_{NI}) > \zeta_{NI}$ where $\delta$ is the relevant difference in mean ppFEV1, $\epsilon_{NI}$ and $\zeta_{NI}$ correspond to a non-inferiority margin and an evidential requirement in terms of a probability threshold.
+ For futility, we evaluate $\text{Pr}(\delta < \epsilon_{fut}) > \zeta_{fut}$ where $\epsilon_{fut}$ and $\zeta_{fut}$ correspond to a reference value and an evidential minimum in terms of a probability threshold.


# Scenarios {#sec-scenarios}

Each scenario adopts a maximum sample size of 600 with interim analyses run when `r paste0(cumsum(l_spec_1$N)[-length(l_spec_1$N)], collapse = ", ")` enrolments have occurred.
The treatment effects were specified as differences in mean ppFEV1 at the 12-month followup as shown in @tbl-scenarios.

All simulations used the same reference values and decision thresholds.

```{r, echo = F, eval = T}
#| label: scenario_list
#| code-summary: Scenarios

i <- 1
d_scenarios <- data.table()

# For each scenario that was simulated
for(i in 1:length(l)){
  
  pwd_segs <- nrow(l[[i]]$cfg$basis_ix_seg)
  
  # main effect
  b_T <- unlist(l[[i]]$cfg$b_T)
  # time interaction
  b_tT <- l[[i]]$cfg$b_tT
  # cumulative effects
  b_tT <- apply(b_tT, 1, cumsum)
  
  d_scenarios <- rbind(
    d_scenarios,
    data.table(
      id = i,
      desc = l[[i]]$cfg$desc,
      time = 1:pwd_segs,
      delta_2_1 = c(b_T[1] + b_tT[, 1]),
      delta_3_1 = c(b_T[2] + b_tT[, 2])
    )
  )
}

d_scenarios[time %in% 2:pwd_segs, desc := ""]
d_scenarios[, id := as.character(id)]
d_scenarios[time %in% 2:pwd_segs, id := ""]
```

```{r, eval = T}
#| echo: FALSE
#| label: tbl-scenarios
#| tbl-pos: H
#| tbl-cap: "Simulation scenarios"

gt_tbl <- gt(d_scenarios) |>
  cols_width(
    id ~ pct(10),
    desc ~ pct(30),
    time ~ pct(20),
    delta_2_1 ~ pct(20),
    delta_3_1 ~ pct(20)
  ) |>
  cols_align(
    columns = 1:3,
    align = "left"
  ) |>
  cols_align(
    columns = 4:5,
    align = "center"
  )  |>
  tab_spanner(
    label = md("Difference in mean ppFEV1 relative to SoC"),
    columns = 3:4
  ) |>
  cols_label(
    id = "ID",
    desc = "Scenario",
    time = "Quarter",
    delta_2_1 = "Deferred",
    delta_3_1 = "Discontinue"
  ) |>
  tab_options(
    table.width = pct(90),
    container.width = pct(90),
    table.font.size = pct(55)) 

gt_tbl 
```

# Results


## Probability of triggering decisions

@tbl-cprob-decision provides the cumulative probability of non-inferiority by scenario with the probability of declaring futility in parentheses.

```{r, echo = F, eval = T}
#| label: cum_prob_dec
#| code-summary: Cumulative probability of each decision type

# Cumulative probability of decisions:

# Traverse the list of simulation results and for each one summarise the 
# cumulative probability of each decision type.

i <- 1
d_cprob_dec <- data.table()

# For each scenario that was simulated
for(i in 1:length(l)){
  
  # extract the decision matrix - sim, analysis, quantity, domain level decision
  d_dec_1 <- copy(l[[i]]$d_pr_dec[par %in% c("delta_2_1", "delta_3_1")])
  
  # config for scenario
  l_cfg <- copy(l[[i]]$cfg)
  
  # number of enrolments at each interim (interim sample size sequence)
  d_N <- data.table(ic = seq_along(l_cfg$N), N = cumsum(l_cfg$N))
  
  
  # compute the cumulative instances of a decision being made by sim, each 
  # decision type and by parameter
  d_dec_1[, cdec := as.integer(cumsum(dec)>0), keyby = .(sim, rule, par)]
  d_dec_1[, cdec := nafill(cdec, type = "locf"), keyby = .(sim, rule, par)]
  d_dec_1[, cdec := as.logical(cdec)]
  
  d_dec_1 <- base::merge(d_dec_1, d_N, by = "ic")
  
  # cumulative proportion for which each decision quantity has been met by 
  # analysis and domain
  d_dec_1 <- d_dec_1[, .(pr_val = mean(cdec)), keyby = .(ic, N, rule, par)]
  
  
  d_cprob_dec <- rbind(
    d_cprob_dec,
    cbind(scenario = i, desc = l_cfg$desc, d_dec_1)
  )

}

```


```{r, eval = T}
#| echo: FALSE
#| label: tbl-cprob-decision
#| tbl-cap: 'Cumulative probability of decision for each enrolment cohort'
#| tbl-pos: H

d_tbl_1_cur <- copy(d_cprob_dec)
d_tbl_1_cur <- dcast(
  d_tbl_1_cur, scenario + desc + par ~ rule + N, value.var = "pr_val")

d_tbl_1_cur[par == "delta_2_1", par := "Deferred"]
d_tbl_1_cur[par == "delta_3_1", par := "Discontinued"]

d_b_trt <- data.table()

for(i in 1:length(l)){
  l_cfg <- copy(l[[i]]$cfg)
  
  
  # main effect
  b_T <- unlist(l_cfg$b_T)
  # time interaction
  b_tT <- l_cfg$b_tT
  # cumulative effects
  b_trt <- c(
    b_T[1] + sum(b_tT[1, ]),
    b_T[2] + sum(b_tT[2, ])
  )
  
  d_tmp <- data.table(
    scenario = i, 
    par = c("Deferred", "Discontinued"), 
    delta = b_trt
  )
  d_b_trt <- rbind(d_b_trt, d_tmp)
}

d_tbl_1_cur <- base::merge(d_tbl_1_cur, d_b_trt, by = c("scenario", "par"))

setcolorder(d_tbl_1_cur, c("scenario", "desc", "par", "delta"))
setorderv(d_tbl_1_cur, cols = c("scenario"))

d_tbl_1_cur <- d_tbl_1_cur[, .SD, .SDcols = !c("scenario")]

g_tbl <- d_tbl_1_cur |> 
  gt(groupname_col = "desc") |> 
  gt::text_transform(
    locations = cells_row_groups(),
    fn = function(x) {
      lapply(x, function(x) {
        gt::md(paste0("*", x, "*"))
      })
    }
  ) |>
  cols_align(
    columns = 1:2,
    align = "left"
  )  |> 
  cols_align(
    columns = 3:ncol(d_tbl_1_cur),
    align = "center"
  )  |> 
  cols_merge(
    columns = c("ni_400", "fut_400"
                ),
    pattern = "<<{1}>><< ({2})>>"
  ) |> 
  cols_merge(
    columns = c("ni_500", "fut_500"
                ),
    pattern = "<<{1}>><< ({2})>>"
  )   |>
  cols_merge(
    columns = c("ni_600", "fut_600"
                ),
    pattern = "<<{1}>><< ({2})>>"
  )   |> 
  cols_width(
    starts_with("ni") ~ px(90)
  ) |>
  tab_spanner(
    label = md("Participants having reached primary endpoint"),
    columns = 4:ncol(d_tbl_1_cur)
  )  |>
  cols_label(
    delta = "Diff at 12 month vs SoC",
    par = "",
    ni_400 = html("400"),
    ni_500 = html("500"),
    ni_600 = html("600")
  ) |>
  tab_options(
    table.font.size = pct(55),
    latex.use_longtable = TRUE,
    latex.header_repeat = TRUE 
  ) |>
  fmt_number(decimals = 2, drop_trailing_zeros = F)

g_tbl
```


{{< pagebreak >}}

## Sample size

@tbl-n-1 shows the expected number of participants on each treatment arm under each scenario.

```{r, echo = F, eval = T}
#| label: sample_size_1
#| code-summary: Compute expected sample size


i <- 1
d_N_by_rand <- data.table()

for(i in 1:length(l)){
  
  # config for scenario
  l_cfg <- copy(l[[i]]$cfg)
  
  N_analysis <- length(l_cfg$N)
  N_trt <- 3
  # 
  d_grid <- CJ(
    sim = 1:l_cfg$nsim,
    ic = 1:N_analysis,
    trt = 1:N_trt
  )
    
  # pick up the baseline obs only, i.e. when the number enrolled
  d_all <- copy(l[[i]]$d_all[, .SD[1], keyby = .(sim, id)])
  
  d_all <- base::merge(
    d_grid,
    d_all[, .(.N), keyby = .(sim, ic, trt)],
    by = c("sim", "ic", "trt"),
    all.x = T
  )
  
  # some arms stop and so there is no suubsequent enrolment
  d_all[is.na(N), N := 0]
  d_all[, N_cmtv := cumsum(N), keyby = .(sim, trt)]
  
  d_N_by_rand <- rbind(
    d_N_by_rand,
    cbind(
      scenario = i, desc = l_cfg$desc, 
      d_all
    )
  )
  
}
```

```{r, eval = T}
#| echo: FALSE
#| label: tbl-n-1
#| tbl-cap: 'Expected number of participants **enrolled** by treatment group for each scenario'
#| tbl-pos: H

# DONT assume that all arms ran to the final interim. The result is just an
# artefact of imputation. Nevertheless it gives the true sample size by arm.
d_N_trt <- d_N_by_rand[, .SD[.N], keyby = .(scenario, desc, sim, trt)]
d_N_tot <- d_N_trt[, .(N_cmtv = sum(N_cmtv)), keyby = .(scenario, desc, sim) ]

# add in total sample size
d_tbl_1_cur <- rbind(
  d_N_trt[, .(N_mu = mean(N_cmtv), N_sd = sd(N_cmtv)), keyby = .(scenario, desc, trt)],
  d_N_tot[, .(trt = "all", N_mu = mean(N_cmtv), N_sd = sd(N_cmtv)), keyby = .(scenario, desc)]
)

d_tbl_1_cur[trt == 1, trt := "SoC"]
d_tbl_1_cur[trt == 2, trt := "Deferred"]
d_tbl_1_cur[trt == 3, trt := "Discontinued"]

# we are only interested in Deferred vs soc and Discontinued vs soc
d_b_trt <- data.table()

for(i in 1:length(l)){
  l_cfg <- copy(l[[i]]$cfg)
  
  # main effect
  b_T <- unlist(l_cfg$b_T)
  # time interaction
  b_tT <- l_cfg$b_tT
  # cumulative effects
  b_trt <- c(
    b_T[1] + sum(b_tT[1, ]),
    b_T[2] + sum(b_tT[2, ])
  )
  
  d_tmp <- data.table(
    scenario = i, 
    trt = c("Deferred", "Discontinued"), 
    delta = c(b_trt[1], b_trt[2]))
  d_b_trt <- rbind(d_b_trt, d_tmp)
}

d_tbl_1_cur <- base::merge(
  d_tbl_1_cur, 
  d_b_trt, 
  by = c("scenario", "trt"),
  all.x = T)

d_tbl_1_cur <- dcast(
  d_tbl_1_cur, 
  scenario + desc ~ trt , 
  value.var = list("N_mu", "N_sd", "delta"))

d_tbl_1_cur[, `:=`(delta_SoC = NULL, delta_all = NULL)]

setcolorder(d_tbl_1_cur, c("scenario", "desc", "delta_Deferred", "delta_Discontinued"))

d_tbl_1_cur <- d_tbl_1_cur[order(scenario, desc)]
d_tbl_1_cur <- d_tbl_1_cur[, .SD, .SDcols = !c("scenario")]



g_tbl <- d_tbl_1_cur |> 
  gt(groupname_col = "desc")  |> 
  gt::text_transform(
    locations = cells_row_groups(),
    fn = function(x) {
      lapply(x, function(x) {
        gt::md(paste0("*", x, "*"))
      })
    }
  ) |>
  fmt_number(
    columns = starts_with("N_"),
    decimals = 0, drop_trailing_zeros = TRUE) |>
  fmt_number(
    columns = starts_with("delta"),
    decimals = 2, drop_trailing_zeros = TRUE) |> 
  tab_spanner(
    label = md("Diff at 12 month vs SoC"),
    columns = starts_with("delta"),
  ) |>
  tab_spanner(
    label = md("Sample size, mean (sd)"),
    columns =  starts_with("N_mu")
  ) |>
  cols_align(
    columns = starts_with("delta"),
    align = "center"
  ) |>
  cols_align(
    columns = starts_with("N_mu"),
    align = "center"
  )  |>
  cols_merge(
    columns = c("N_mu_Deferred", "N_sd_Deferred"
                ),
    pattern = "<<{1}>><< ({2})>>"
  ) |>
  cols_merge(
    columns = c("N_mu_Discontinued", "N_sd_Discontinued"
                ),
    pattern = "<<{1}>><< ({2})>>"
  ) |>
  cols_merge(
    columns = c("N_mu_SoC", "N_sd_SoC"
                ),
    pattern = "<<{1}>><< ({2})>>"
  ) |>
  cols_merge(
    columns = c("N_mu_all", "N_sd_all"
                ),
    pattern = "<<{1}>><< ({2})>>"
  ) |>
  cols_label(
    delta_Deferred = "Deferred",
    delta_Discontinued = "Discontinued",
    N_mu_Deferred = "Deferred",
    N_mu_Discontinued = "Discontinued",
    N_mu_SoC = "SoC",
    N_mu_all = "Total"
  ) |>
  tab_options(
    # table.width = pct(100),
    table.font.size = pct(55)
  ) 


g_tbl
```







